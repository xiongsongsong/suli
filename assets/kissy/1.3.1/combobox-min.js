/*
Copyright 2013, KISSY UI Library v1.31
MIT Licensed
build time: Aug 15 00:00
*/
KISSY.add("combobox/base",function(h,c,k,l,i,f){function b(e){for(var a=0;a<e.length;a++)if(!e[a].get("disabled"))return e[a];return null}function a(){this.get("input")[0].focus();s.call(this)}function d(e,a){var b=e.get("el"),d=e.get("prefixCls")+"combobox-invalid",o=e.get("invalidEl");a?(b.addClass(d),o.attr("title",a),o.show()):(b.removeClass(d),o.hide())}function o(e,a){var b=e.get("menu");if(b&&!b.isController)if(a)b=k.create(b,e),e.setInternal("menu",b);else return null;return b}function g(){var e=
o(this);e&&e.get("visible")&&this.alignInternal()}function j(){var e=this;e._focusoutDismissTimer=setTimeout(function(){e._focusoutDismissTimer&&e.set("collapsed",!0)},50)}function s(){var e;if(e=this._focusoutDismissTimer)clearTimeout(e),this._focusoutDismissTimer=null}function t(){var e;this._stopNotify||(e=this.getValueInternal(),e===f?this.set("collapsed",!0):(this._savedInputValue=e,this.sendRequest(e)))}function q(e){var a,b=[],d,f,c=o(this,1),e=this.normalizeData(e);c.removeChildren(!0);c.set("highlightedItem",
null);if(e&&e.length){for(f=0;f<e.length;f++)a=e[f],b.push(c.addChild(a));if(this.get("highlightMatchItem")){e=this.getValueInternal();for(f=0;f<b.length;f++)if(b[f].get("textContent")==e){c.set("highlightedItem",b[f]);d=!0;break}}if(!d&&this.get("autoHighlightFirst"))for(f=0;f<b.length;f++)if(!b[f].get("disabled")){c.set("highlightedItem",b[f]);break}this.set("collapsed",!1);g.call(this)}else this.set("collapsed",!0)}var r,i=c.all,m=c.KeyCodes,n={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},
p=i(h.Env.host);return r=k.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(e){var a,b,d;if(e&&e.length){e=e.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueInternal(),e):[];for(d=0;d<e.length;d++)b=e[d],a[d]=h.mix({content:b,textContent:b,value:b},a[d])}return a},bindUI:function(){this.get("input").on("valuechange",t,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(e){this.get("input").val(e)},
alignInternal:function(){var e=this.get("menu"),a=h.clone(e.get("align"));a.node=this.get("el");h.mix(a,n,!1);e.set("align",a)},handleFocus:function(){var e;d(this,!1);(e=this.get("placeholderEl"))&&e.hide()},handleBlur:function(){var e=this,a=e.get("placeholderEl"),b;r.superclass.handleBlur.apply(e,arguments);j.call(e);b=e.get("input");e.validate(function(a,f){a?!e.get("focused")&&f==b.val()&&d(e,a):d(e,!1)});a&&!b.val()&&a.show()},handleMouseDown:function(e){var a,b;r.superclass.handleMouseDown.apply(this,
arguments);a=e.target;b=this.get("trigger");if(this.get("hasTrigger")&&(b[0]==a||b.contains(a)))a=this.get("input"),this.get("collapsed")?(a[0].focus(),this.sendRequest("")):this.set("collapsed",!0),e.preventDefault()},handleKeyEventInternal:function(a){var d,c=a.keyCode,g,j=o(this);this.get("input");if(d=this.get("updateInputOnDownUp"))this._stopNotify=h.inArray(a.keyCode,[m.UP,m.DOWN,m.ESC])?1:0;if(j&&j.get("visible")){g=j.get("activeItem");if(d&&g){var i=j.get("children");if(c==m.DOWN&&g==b(i.concat().reverse())||
c==m.UP&&g==b(i))return this.setValueInternal(this._savedInputValue),j.set("highlightedItem",null),!0}c=j.handleKeydown(a);if(a.keyCode==m.ESC)return this.set("collapsed",!0),d&&this.setValueInternal(this._savedInputValue),!0;g=j.get("activeItem");d&&h.inArray(a.keyCode,[m.DOWN,m.UP])&&this.setValueInternal(g.get("textContent"));return a.keyCode==m.TAB&&g&&(g.performActionInternal(),this.get("multiple"))?!0:c}if(a.keyCode==m.DOWN||a.keyCode==m.UP)if(a=this.getValueInternal(),a!==f)return this.sendRequest(a),
!0;return f},syncUI:function(){var a=this.get("input"),b=this.get("inputValue");b!=f&&a.val(b);this.get("placeholder")&&(a.val()||this.get("placeholderEl").show())},validate:function(a){var b=this.get("validator"),d=this.get("input").val();b?b(d,function(b){a(b,d)}):a(!1,d)},bindMenu:function(){var b=this,d,f;f=b.get("menu");f.on("click",function(a){a=a.target.get("textContent");b._stopNotify=1;b.setValueInternal(a);b._savedInputValue=a;b.set("collapsed",!0);setTimeout(function(){b._stopNotify=0},
50)});p.on("resize",b.__repositionBuffer=h.buffer(g,50),b);d=f.get("el");f=f.get("contentEl");d.on("focusout",j,b);d.on("focusin",function(){setTimeout(function(){s.call(b)},0)},b);f.on("mouseover",a,b);f.on("mousedown",function(){b._stopNotify=1});f.on("mouseup",function(){b._stopNotify=0});b.bindMenu=h.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,q,this)},_onSetCollapsed:function(a){if(a)(a=o(this))&&a.hide();else{var a=this.get("el"),b=o(this,1);s.call(this);if(b&&!b.get("visible")){b.render();
this.bindMenu();if(this.get("matchElWidth")){b.render();var d=b.get("el"),d=(parseInt(d.css("borderLeftWidth"))||0)+(parseInt(d.css("borderRightWidth"))||0);b.set("width",a[0].offsetWidth-d)}b.show();this.get("input").attr("aria-owns",b.get("el").attr("id"))}}},destructor:function(){var a=this.__repositionBuffer;a&&(p.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},
hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildXClass:{value:"popupmenu"},collapsed:{view:1},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:l}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox",function(h,c,k,l,i,f){c.LocalDataSource=i;c.RemoteDataSource=f;c.FilterSelect=l;c.MultiValueComboBox=k;return c},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(h,c){function k(b){var a=i,d;a||(a=c.create(l));"textarea"==""+b.type?c.css(a,"width",c.css(b,"width")):c.css(a,"width",9999);h.each(f,function(d){c.css(a,d,c.css(b,d))});i||(d=b.ownerDocument.body,d.insertBefore(a,d.firstChild));return i=a}var l="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",i,f="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=c.get(b),a=b.ownerDocument,d,f,g=b.scrollTop,j=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+j+c.scrollLeft(),top:a.boundingTop+g+a.boundingHeight+c.scrollTop()};d=c.offset(b);if("textarea"!=b.type)return d.top+=b.offsetHeight,d;f=k(b);a=b.selectionStart;f.innerHTML=h.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";c.offset(f,d);d=f.lastChild;b=c.offset(d);b.top+=c.height(d);0<a&&(b.left+=c.width(d));b.top-=g;b.left-=j;return b}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(h,c){var k=c.extend({validate:function(c){var i=this;k.superclass.validate.call(i,function(f,b){f?c(f,b):i.get("dataSource").fetchData(b,function(a){a:{if(a=i.normalizeData(a))for(var d=0;d<a.length;d++)if(a[d].textContent==b){a=a[d];break a}a=!1}c(a?"":i.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return k},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(h){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={data:{value:[]},parse:{value:function(c,l){var i=[],f=0;if(!c)return l;h.each(l,function(b){-1!=b.indexOf(c)&&i.push(b);f++});return i}}};h.extend(c,h.Base,{fetchData:function(c,h,i){var f=this.get("parse"),b=this.get("data"),b=f(c,b);h.call(i,b)}});return c},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(h,c,k){function l(a,b){return b&&-1!=a.indexOf(b)}function i(a){var d=a.get("input"),c=d.val(),g=[],j=[],i=a.get("literal"),h=a.get("separator"),a=a.get("separatorType"),k=!1,r=a!=f,d=d.prop("selectionStart"),m,n,p=-1;for(m=0;m<c.length;m++)(n=c.charAt(m),i&&n==i&&(k=!k),k)?j.push(n):(m==d&&(p=g.length),r&&b.test(n))?(j.length&&g.push(j.join("")),j=[],j.push(n)):l(h,n)?a==f?(j.push(n),j.length&&g.push(j.join("")),j=[]):(j.length&&g.push(j.join("")),
j=[],j.push(n)):j.push(n);j.length&&g.push(j.join(""));g.length||g.push("");-1==p&&(a==f&&l(h,n)&&g.push(""),p=g.length-1);return{tokens:g,cursorPosition:d,tokenIndex:p}}var f="suffix",b=/\s|\xa0/;return k.extend({getValueInternal:function(){this.get("input");var a=i(this),b=a.tokens,c=a.tokenIndex,a=this.get("separator"),g=this.get("separatorType"),b=b[c],c=b.length-1;if(g!=f)if(l(a,b.charAt(0)))b=b.slice(1);else return;else g==f&&l(a,b.charAt(c))&&(b=b.slice(0,c));return b},setValueInternal:function(a){var d=
this.get("input"),c=i(this),g=c.tokens,c=Math.max(0,c.tokenIndex),j=this.get("separator"),h=this.get("separatorType"),k=g[c+1]||"",q=g[c];if(h!=f){if(g[c]=q.charAt(0)+a,!k||!b.test(k.charAt(0)))g[c]+=" "}else g[c]=a,a=q.length-1,l(j,q.charAt(a))?g[c]+=q.charAt(a):1==j.length&&(g[c]+=j);a=g.slice(0,c+1).join("").length;d.val(g.join(""));d.prop("selectionStart",a);d.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=i(this),b=a.tokens,f=this.get("menu"),g=a.cursorPosition,
j=a.tokenIndex,a=this.get("input"),b=b.slice(0,j).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=c(a);a.prop("selectionStart",g);a.prop("selectionEnd",g);f.set("xy",[b.left,b.top])}else k.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:f},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(h,c){function k(){k.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}k.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};h.extend(k,h.Base,{fetchData:function(h,i,f){var b=this,a,d=b.get("paramName"),k=b.get("parse"),g=b.get("cache"),j=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!h&&!0!==j)return i.call(f,[]);if(g&&(a=b.caches[h]))return i.call(f,a);a=b.get("xhrCfg");a.data=a.data||{};a.data[d]=
h;a.success=function(a){k&&(a=k(h,a));b.setInternal("data",a);g&&(b.caches[h]=a);i.call(f,a)};b.io=c(a)}});return k},{requires:["ajax"]});
KISSY.add("combobox/render",function(h,c,k){var l=h.all,i=c.Render.extend({createDom:function(){var c,b=this.get("input"),a=this.get("prefixCls"),d=this.get("el"),i=this.get("trigger");this.get("srcNode")||(d.append(h.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:a})),c=d.one("."+a+"combobox-input-wrap"),b=b||h.all(h.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',{prefixCls:a})),
c.append(b),this.setInternal("input",b));i||this.setInternal("trigger",h.all(h.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:a})));this.get("trigger").unselectable(k);this.setInternal("invalidEl",l("<div class='"+a+"combobox-invalid-el'><div class='"+a+"combobox-invalid-inner'></div></div>").insertBefore(b.parent(k,k),k));if(i=this.get("placeholder")){if(!(c=b.attr("id")))b.attr("id",c=h.guid("ks-combobox-input"));
this.setInternal("placeholderEl",l('<label for="'+c+'" class="'+a+'combobox-placeholder">'+i+"</label>").appendTo(d))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var b=this.get("trigger");c?this.get("el").prepend(b):b.remove()},_onSetDisabled:function(c){i.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return i},{requires:["component/base"]});
