define("sjplus/global/0.0.1/comment/comment",["template","s/global/login/login","./comment-block.tpl","./comment-textarea.tpl"],function(a,b){function c(){l.scrollTop()+l.height()>i.offset().top&&(l.off("scroll",c),d())}function d(){a.async("./comment.css",function(){f=i.find("h2"),e()}),$("#J-comment-wrapper").html(a("./comment-textarea.tpl"))}function e(){KISSY.use("gallery/waterfall/1.0/,node,ajax,dom,event",function(a,c,d,e){var h=(d.all,1),i=!0;b.waterfall=new c.Loader({container:"#comment-container",load:function(b,c){e({data:{id:j,page:h,per_page:10},url:"/comment/list",dataType:"jsonp",success:function(d){if(i&&d.total_count>0&&(f.html(d.total_count>0?'<span class="J-count">'+d.total_count+"</span>条评论":"暂无评论"),i=!1),"ok"!==d.status)return c(),i&&(f.html('<span class="J-count">0</span>条评论'),i=!1),void 0;var e=[];a.each(d.docs,function(b){e.push(new a.Node(g.render(n,b)))}),h=d.page+1,h>d.total_page&&c(),b(e)},complete:function(){}})},minColCount:2,colWidth:390})})}var f,g=a("template"),h=a("s/global/login/login"),i=$("#J-comment-wrapper"),j=i.attr("data-page-id"),k=i.attr("data-type"),l=$(window),m=a("./comment-block.tpl"),n=g.compile(m);l.on("scroll",c),c();var o=$(document.body);o.on("click",".J-send-new-comment-trigger",function(){var a=$(this),c=a.parents(".J-new-comment"),d=c.find("textarea"),e=d.val();$.post("/comment/new",{content:e,_csrf:window._csrf_token_,_id:j,type:k},function(a){if(a.docs){$(g.render(n,a.docs)).insertAfter($("#comment-container>div.ks-waterfall").eq(0)),b.waterfall.adjust();var c=parseInt(f.find("span.J-count").html(),10);f.find("span.J-count").html(c+1),d.val(""),$(".J-comment").find(".J-count").html(c+1)}else-1==a.status?h.login():alert("遇到错误：\r\n"+a.err.join("\r\n"))})}),o.on("click",".J-comment-trigger",function(){$("#J-comment-textarea").focus()})}),define("sjplus/global/0.0.1/comment/comment-block.tpl",[],'<div class="item-container J-comment-item ks-waterfall" data-owner-id="#{owner_id}">\n    <div class="container">\n        <div class="user-info">\n            <div class="user"><a class="avatar" href="/u/#{owner_id}"><img src="#{imgCDN}/avatar/#{owner_id}_20x20"></a><span\n                    class="user-name">#if(typeof owner_user===\'string\')#{owner_user}#end</span></div>\n            <div class="date">\n                #run var date=new Date(ts)\n                #{date.getFullYear()}.#{date.getMonth()+1}.#{date.getDate()}-#{date.getHours()}:#{date.getMinutes()}:#{date.getSeconds()}\n            </div>\n        </div>\n        <div class="content J-comment-area">#{content}<div class="J-reply-trigger reply-trigger">\n            <a href="#" class="J-reply">回复</a></div>\n        </div>\n    </div>\n</div>\n'),define("sjplus/global/0.0.1/comment/comment-textarea.tpl",[],'<div id="J-comment-container" data-id="#{page-id}" class="J-comment-container"><h2>正在加载评论...</h2>\n    <div id="comment-container" class="comment-container">\n        <div class="item-container new-comment J-new-comment ks-waterfall">\n            <textarea id="J-comment-textarea" data-id="#{page-id}"></textarea>\n            <div class="J-send-new-comment">\n                <button class="J-send-new-comment-trigger btn btn-normal">发送</button>\n            </div>\n        </div>\n    </div>\n</div>\n');
