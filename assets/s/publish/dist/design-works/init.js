define("sjplus/publish/0.0.1/design-works/init",["./upload-main-file","sea/upload/upload","./upload-thumbnails","./upload-ps","./tag"],function(a){a("./upload-main-file"),a("./upload-thumbnails"),a("./upload-ps"),a("./tag");var b=document.forms.publish;$(document.forms.publish).on("submit",function(a){return a.preventDefault(),$(b).find(".J-process-running").length>0?(alert("请稍等，文件正在上传"),void 0):($.post("/publish/design-works/save",$(b).serialize(),function(a){if(a&&a.docs)window.location.href='/personal#all-works{"view":"design"}';else switch(alert("遇到错误:\r\n"+a.err.join("\r\n")),a.errType){case"category":b.elements.category.focus()}}),void 0)})}),define("sjplus/publish/0.0.1/design-works/upload-main-file",["sea/upload/upload"],function(a){var b="/publish/design-works/save-main-file",c=a("sea/upload/upload"),d=$(".J-mail-file-status"),e=new c({trigger:"#J-upload-file-triggers",name:"file",action:b,data:{_csrf:window._csrf_token_}}).change(function(){e.submit()}).success(function(a){try{var b=$.parseJSON(a);b._id&&!b.err?($("#main-file_id").val(b._id),$("#main-file-preview").attr("src",window.imgCDN+"/read/"+b._id.split(":")[0]),d.addClass("text-success").removeClass("text-error").html("上传成功")):d.addClass("text-error").removeClass("text-success").html("上传失败："+b.err)}catch(c){d.addClass("text-error").removeClass("text-success").html("上传失败")}})}),define("sjplus/publish/0.0.1/design-works/upload-thumbnails",["sea/upload/upload"],function(a){var b=a("sea/upload/upload"),c="/publish/design-works/save-thumbnails",d=$(".J-thumbnails-status"),e=new b({trigger:"#upload_thumbnails",name:"file",action:c,data:{_csrf:window._csrf_token_}}).change(function(){e.submit()}).success(function(a){try{var b=$.parseJSON(a);b._id&&!b.err?($("#thumbnails_id").val(b._id),d.addClass("text-success").removeClass("text-error").html("上传成功")):d.addClass("text-error").removeClass("text-success").html("上传失败："+b.err)}catch(c){alert("服务器出错")}})}),define("sjplus/publish/0.0.1/design-works/upload-ps",["sea/upload/upload"],function(a){function b(){h.val("");var a=[];f.find(".J-success").each(function(b,c){a.push($(c).data("id"))}),h.val(a.join("\r\n"))}var c,d,e="/publish/design-works/save-ps",f=$("#ps-list"),g=a("sea/upload/upload"),h=$("#ps_id"),i=new g({trigger:"#upload-ps",name:"file",action:e,data:{_csrf:window._csrf_token_}}).change(function(a){c="ps_file"+(1e8*Math.random(),10),f.innerHTML="",$('<div class="j-ps-file" id="'+c+'">'+a+'<span class="J-process J-process-running" ><b style="color: red;">正在上传...</b></span></div>').appendTo(f),d=$("#"+c),i.submit()}).success(function(a){try{var c=$.parseJSON(a);c._id&&!c.err?(d.addClass("J-success").data("id",c._id),d.find(".J-process").html('<b style="color: green;">上传成功</b>'),d.find(".J-process-running").removeClass("J-process-running"),b()):d.find(".J-process").html("上传失败："+c.err.join(","))}catch(e){d.find(".J-process").html("服务器异常"+a)}}).error(function(){d.find(".J-process").html("上传失败，请确认文件小于200Mb")})}),define("sjplus/publish/0.0.1/design-works/tag",[],function(a,b){function c(a){a=d.trim(a),j.test(a)&&(i[a]||(i[a]=a,$('<a class="tag J-tag">'+a+'<span class="delete J-delete" data-text="'+a+'">&times;</span></a>').appendTo(g),h.val(d.keys(i).join(" "))))}var d=KISSY,e=$("#tag"),f=$("#tag-field"),g=$("#tag-control"),h=$("#tag-value");a.async("/go/design-works/tag?r="+d.now()+"&callback=define",function(a){var b=d.map(a.replace(/\s/gim,"").split(/[，,]/),function(a){return'<option value="'+a+'"></option>'});$("#tagList").html(b)});var i={},j=/^[\u4e00-\u9fa5A-Za-z0-9]{2,}$/;f.on("keydown",function(a){setTimeout(function(){var b=f.val();b.replace(/\s/g,"").length>0&&("   "===b.substring(b.length-3)||"blur"===a.type)&&(j.test(d.trim(b))?(c(f.val()),f.val(""),console.log(b+"符合规则")):console.log(b+"不符合规则"))},0)}),f.on("blur",function(){var a=d.trim(f.val());d.each(a.split(" "),function(a){j.test(a)&&c(a)}),f.val("")}),g.on("click",".J-delete",function(a){a.preventDefault();var b=$(a.currentTarget).data("text");delete i[b],$(a.currentTarget).parents(".J-tag").remove(),h.val(d.keys(i).join(" "))}),e.on("click",function(a){a.target===e[0]&&f.focus()}),b.tag=i});
