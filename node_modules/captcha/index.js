/**
 * Created by 松松 on 13-11-26.
 */

var app = require('app')
var gm = require('gm')
var path = require('path')
var fs = require('fs')

app.get('/captcha', function (req, res) {
    var fileName = Math.random() + '' + req.sessionID + Date.now()
    var code = parseInt(Math.random() * 10000, 10).toString().substring(0, 5)
    req.session.captche = code
    var newPath = path.join(__dirname, fileName + '.png')
    /*gm(path.join(__dirname, 'captcha.png')).drawText(0, 0, "dddd").write(newPath, function (err, docs) {
        res.status(200)
        res.header('Content-type', 'image/png')
        res.sendfile(newPath, function (err, docs) {
            console.log('发送验证码：', err, docs)
            fs.unlink(newPath, function (err, docs) {
                console.log('删除验证码：', err, docs)
            })
        })
    })*/

    gm(200, 400, "#ddff99f3")
        .drawText(10, 50, "from scratch")
        .write(newPath, function (err) {
            res.sendfile(newPath, function (err, docs) {

            })
        });
})
